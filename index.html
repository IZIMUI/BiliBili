<!DOCTYPE html>
<html>
<head>
<title>B站直播间语音播报</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
</head>
<body>
<div align="center">
直播间房号：<input id="Room_ID" style="text-align:center;"/>
<button id="Bind">绑定&改绑</button>
<br>
<br>
播报语速：<input id="SOS" style="text-align:center;" value="2"/><br>
播报音调：<input id="Tone" style="text-align:center;" value="2"/>
<br>
<br>
<button id="Seve">保存&应用</button>
<br>
<button id="Run">开始播报</button>
<br>
<button id="Close">停止播报</button>
<br>
<br>
<textarea id="Content" rows="70" cols="50" readonly></textarea>
</div>
</body>
<script>
function DanMu(Room_Number, Callback) {
function ReadInt(Buffer, Start, Len) {
  let Result = 0;
  for (let Value = Len - 1; Value >= 0; Value--) {
    Result += Math.pow(256, Len - Value - 1) * Buffer[Start + Value];
  };
  return Result;
};

function WriteInt(Buffer, Value) {
  let Values = 0;
  while (Values < 4) {
    Buffer[Values] = Value / Math.pow(256, 4 - Values - 1);
    Values++;
  }
};

function Encode(Str, Op) {
  const Data = new TextEncoder("utf-8").encode(Str);
  const PacketLen = 16 + Data.byteLength;
  const Header = [0, 0, 0, 0, 0, 16, 0, 1, 0, 0, 0, Op, 0, 0, 0, 1];
  WriteInt(Header, PacketLen);
  return (new Uint8Array(Header.concat(...Data))).buffer;
};

function Decode(Blob) {
  return new Promise(function(Resolve, reject) {
    let Reader = new FileReader();
    Reader.onload = function(Event) {
      let Buffer = new Uint8Array(Event.target.result);
      let Result = {};
      Result.Code = ReadInt(Buffer, 8, 4);
      if (Result.Code === 5) {
        Result.Body = [];
        let Offset = 0;
        while (Offset < Buffer.length) {
          let PacketLen = ReadInt(Buffer, Offset, 4);
          let Body = new TextDecoder("utf-8").decode(Buffer.slice(Offset + 16, Offset + PacketLen));
          if (Body) {
            Result.Body.push(JSON.parse(Body));
          }
          Offset += PacketLen;
        }
      } else if (Result.Code === 3) {
        Result.Body = {
          count: ReadInt(Buffer, 16, 4)
        };
      }
      Resolve(Result);
    }
    Reader.readAsArrayBuffer(Blob);
  })
};
  ws = new WebSocket("wss://broadcastlv.chat.bilibili.com:2245/sub");
  ws.onopen = function() {
    ws.send(Encode(JSON.stringify({
      "roomid": Room_Number
    }), 7));
    setInterval(function() {
      ws.send(Encode("", 2));
    }, 800);
  }

  ws.onmessage = async function(Event) {
    const Packet = await Decode(Event.data);
    switch (Packet.Code) {
      case 5:
        Packet.Body.forEach(function(Body) {
          switch (Body.cmd) {
            case 'DANMU_MSG':
              Callback(JSON.stringify({"User": Body.info[2][1] ,"Message": Body.info[1]}))
              break;
          }
        })
        break;
    }
  }
}

var Bind;
var Room_ID;
var Run = false;
var SOS = 2;
var Tone = 2;
document.getElementById("Bind").addEventListener("click", function(){
if(Run == false){
if(document.getElementById("Room_ID").value){
alert("绑定成功");
Room_ID = Number(document.getElementById("Room_ID").value);
Bind = true;
} else {
alert("绑定失败，直播间房号不能为空");
}
} else {
alert("请先关闭弹幕播报，在更改新的直播间房号");
}});
document.getElementById("Seve").addEventListener("click", function(){
if(Run == false){
if(document.getElementById("SOS").value){
SOS = document.getElementById("SOS").value;
alert("语速更改成功")
} else {
alert("语速不能为空");
};
if(document.getElementById("Tone").value){
Tone = document.getElementById("Tone").value;
alert("音调更改成功")
} else {
alert("音调不能为空")
}
} else {
alert("请先关闭弹幕播报，在更改新的直播间房号")
}});

document.getElementById("Run").addEventListener("click", function(){
if(Bind){
if(Run == false){
alert("已开始播报")
Run = true;
DanMu(Room_ID, function(Object){
document.getElementById("Content").value += "【" + JSON.parse(Object).User + "】：" + JSON.parse(Object).Message + "\n";
const Message = new SpeechSynthesisUtterance(JSON.parse(Object).User + "说" + JSON.parse(Object).Message);
Message.rate = SOS;
Message.pitch = Tone;
speechSynthesis.speak(Message)
})
} else {
alert("当前已经是弹幕播报状态")
}} else {
alert("请设置直播间房号进行绑定");
}})

document.getElementById("Close").addEventListener("click", function(){
if(Run == true){
alert("已关闭弹幕播报功能");
Run = false;
ws.close();
} else {
alert("当前已经是停止弹幕播报状态")
}
})
</script>
</html>
